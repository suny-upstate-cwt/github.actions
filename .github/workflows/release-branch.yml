name: Create Release Branch
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  create-release-branch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          
      - name: Create Release Branch
        run: |
          VERSION=${{ github.event.inputs.version }}
          RELEASE_BRANCH="release/${VERSION}"
          TODAY=$(date +"%m/%d/%Y")
          
          echo "Creating release branch: $RELEASE_BRANCH"
          git checkout -b "$RELEASE_BRANCH"
          
          # Create temp file
          TEMP_FILE=$(mktemp)
          
          # Process changelog - convert unreleased to version section and remove unreleased
          awk -v version="$VERSION" -v today="$TODAY" -v repo="${GITHUB_REPOSITORY#*/}" '
            BEGIN {
              in_unreleased = 0
              unreleased_content = ""
              printed_version = 0
            }
            
            # Capture the Unreleased section
            /## \*\*.*Unreleased\*\*/ {
              in_unreleased = 1
              next  # Skip printing the Unreleased header
            }
            
            # Start of any other section
            /^## \*\*/ {
              if (in_unreleased && !printed_version && unreleased_content != "") {
                in_unreleased = 0
                printed_version = 1
                # Print the new versioned section before this section
                print ""
                print "## **[(" today ") - " version "](https://github.com/suny-upstate-cwt/" repo "/releases/tag/" version ")**"
                print unreleased_content
                print ""
              }
              in_unreleased = 0
              print
              next
            }
            
            # Collect content from Unreleased section or print other content
            {
              if (in_unreleased && NF > 0) {
                unreleased_content = unreleased_content $0 "\n"
              } else if (!in_unreleased) {
                print
              }
            }
            
            END {
              if (in_unreleased && !printed_version && unreleased_content != "") {
                print ""
                print "## **[(" today ") - " version "](https://github.com/suny-upstate-cwt/" repo "/releases/tag/" version ")**"
                print unreleased_content
              }
            }
          ' CHANGELOG.md > "$TEMP_FILE"
          
          cat "$TEMP_FILE" > CHANGELOG.md
          
          # Commit changes
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "chore: Prepare changelog for $VERSION release"
          
          # Push release branch
          git push origin "$RELEASE_BRANCH"
          
          # Create PR for release branch
          gh pr create \
            --title "Release $VERSION" \
            --body "## Release Preparation for $VERSION
            
            This PR prepares the release for version $VERSION.
            
            ### Changelog Updates
            - Converted Unreleased section to version $VERSION
            - Removed Unreleased section for release
            
            ### Next Steps
            1. Review the changelog
            2. Perform any final release preparations
            3. Merge this PR to develop
            4. Create release tag" \
            --base develop \
            --head "$RELEASE_BRANCH"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}